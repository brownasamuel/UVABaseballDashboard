---
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load packages
library(ggplot2)
library(dplyr)
library(shiny)
library(DT)
library(shinyWidgets)
library(magick)
library(rvest)
library(stringr)
library(janitor)

# Read in data
allGames <- read.csv("C:/Users/brown/Documents/GitHub/UVABaseballDashboard/2023 Season Data.csv")

virginia <-  allGames %>%
  filter(PitcherTeam == 'Virginia') %>%
  mutate(opponent = paste(BatterTeam, sub("/2023", "", Date))) %>%
  select(-c(50:167))

# Get a player's picture
find_pic <- function(name){
  tmpfile <- read_html(paste("https://virginiasports.com/player/", 
                             sub(" ", "-", name) %>% tolower(), 
                             "/",
                             sep = "")) %>%
      html_nodes(xpath = '//*[@class="bio-info"]') %>%
      html_elements("img") %>%
      html_attr("src") %>%
      image_read() %>%
      image_write(tempfile(fileext='jpg'), format = 'jpg')
    
    # Return a list
    list(src = tmpfile, contentType = "image/jpeg", width = 200, height = 260)
}

# Get a player's stats
raw_text <- map("https://static.virginiasports.com/custompages/sports/m-basebl/stats/2022-2023/SeasonStats.pdf?_gl=1*11rpgpg*_ga*MTg1NjExNzA0NC4xNjgwMTg0ODQy*_ga_X9RVV1P9QW*MTY4MTkyNDQ1Ni4xMC4xLjE2ODE5MjQ4NDUuNjAuMC4w&_ga=2.154379455.640199771.1681924456-1856117044.1680184842", 
                pdf_text)[[1]]
pit_stats <- str_split(raw_text, "\n")[[1]][46:63] %>%
  str_squish() %>%
  sub(".*?\\d ", "", x = .) %>%
  sub(" ", "", x = .) %>%
  sub("Playerera", "Player era", x = .) %>%
  data.frame() %>%
  slice(-5) %>%
  row_to_names(row_number = 1) %>%
  separate(names(.), into = str_split(names(.), " ")[[1]], sep = " ") %>%
  mutate(Player = gsub('([[:upper:]])', ' \\1', Player),
         Player = trimws(Player)) 

find_stats <- function(name){
  pit_stats %>%
    filter(Player == name)
}
```

```{r, echo = FALSE}
ui <- fluidPage(
  titlePanel("UVA Baseball Pitching Dashboard"),
  tags$head(
    tags$style(
      HTML(
        "
        
        /* Change the background color of the navbar */
        .navbar {
          background-color: #E57200;
        }
        
        /* Change the color of the text in the navbar */
        .navbar-default .navbar-nav > li > a {
          color: white;
        }
        
        /* Change the color of the active tab */
        .navbar-default .navbar-nav > .active > a,
        .navbar-default .navbar-nav > .active > a:focus,
        .navbar-default .navbar-nav > .active > a:hover {
          background-color: #232D4B;
          color: white;
        }
        "
      )
    )
  ),
  navbarPage(
    title = " ", id = "Dash",
    ### Tab 1- Game Summaries
    tabPanel(title = "Game Summaries",
             sidebarLayout(
               sidebarPanel(width = 4,
                            selectizeInput("pitcher", "Select a Pitcher", 
                                           choices = unique(virginia$Pitcher), 
                                           options = list(placeholder = 'Please select an option below',
                                                          onInitialize = I('function() { this.setValue(""); }'))),
                         
                         uiOutput("Opponent"),
                         
                         uiOutput("PType1")),
               
               mainPanel(width = 8,
                         conditionalPanel("input.PitchType1 != ''",
                                div(plotOutput("pitchZone")))
                         )),
             
             fluidRow(
               column(12,
                      conditionalPanel("input.PitchType1 != ''",
                                       div(DT::dataTableOutput("mytable"), style = "font-size: 70%; width: 100%"))
                      )
               )
             
             
             ),
    
    ### Tab 2- Player profiles(Should I add in a header to each?)
   navbarMenu(title = "Player Profiles",
              # Put in sub tabs
              tabPanel(title = "Connelly Early", value = "Connelly Early",
                       fluidRow(
                         column(2,
                                imageOutput("pic_CE")),
                         column(9,
                                div(dataTableOutput("stats_CE"), style = "font-size: 80%; width: 60%")))),
              tabPanel(title = "Kevin Jaxel", value = "Kevin Jaxel",
                       fluidRow(
                         column(2,
                                imageOutput("pic_KJ")),
                         column(9,
                                div(dataTableOutput("stats_KJ"), style = "font-size: 80%; width: 100%"))))
              )
   )
  )

server = function(input, output) {
  ##################################################################################################################
  ### Tab 1- Game Summaries
  # Select opponent bar
  output$Opponent <- renderUI({
    conditionalPanel("input.pitcher != '' ",
                     pickerInput("opponent", "Game", 
                                 choices = c(virginia %>% 
                                               filter(Pitcher %in% input$pitcher) %>% 
                                               pull(opponent) %>% 
                                               unique()),
                                 options = list('actions-box' = TRUE),
                                 multiple = TRUE))
  })
  
  # Select Pitch type bar
  output$PType1 <- renderUI({
    conditionalPanel("input.opponent != '' ",
                     pickerInput("PitchType1", "Pitch Type", 
                                 choices = virginia %>% 
                                   filter(Pitcher %in% input$pitcher,
                                          opponent %in% input$opponent) %>% 
                                   pull(TaggedPitchType) %>% 
                                   unique(), 
                                 options = list('actions-box' = TRUE),
                                 multiple = TRUE))
  })
  
  # Zone plot of pitches
  output$pitchZone <- renderPlot(
    virginia %>%
      filter(PitchCall != "",
             Pitcher %in% input$pitcher,
             opponent %in% input$opponent,
             TaggedPitchType %in% input$PitchType1) %>%
      ggplot(aes(x = PlateLocSide, y = PlateLocHeight)) +
      geom_point(aes(color = RelSpeed), na.rm = TRUE) +
      xlim(-2.5, 2.5) +
      theme_bw() +
      labs(y = "Pitch Height(ft)", x = "Pitch Horizontal Location(ft) from Pitcher POV", color = "Velocity") +
      geom_path(data = data.frame(x = c(-.8, -.8, .8, .8, -.8),
                                  y = c(1.6, 3.5, 3.5, 1.6, 1.6)), 
                aes(x = x, y = y)) +
      scale_color_gradient(low = "#181C90", high = "#F78707") +
      facet_grid(. ~ TaggedPitchType) +
      coord_equal()
  )
  
  # Pitch results table
  output$mytable <- DT::renderDataTable({
    datatable(virginia %>%
       filter(PitchCall != "",
              Pitcher %in% input$pitcher,
              opponent %in% input$opponent) %>%
       group_by(Pitcher, TaggedPitchType) %>%
       summarize('Sitting Velo' = paste(round(quantile(RelSpeed, .25), 1), 
                                        "-",
                                        round(quantile(RelSpeed, .75), 1)),
                 'Max Velo' = round(max(RelSpeed), 1),
                 'Total Pitches' = n(),
                 Strikes = sum(PitchCall %in% c("StrikeCalled", "StrikeSwinging", "FoulBall", "InPlay")),
                 Balls = sum(PitchCall %in% c("BallCalled", "HitByPitch", "BallinDirt", "BallIntentional")),
                 Swings = sum(PitchCall %in% c("FoulBall", "InPlay", "StrikeSwinging")),
                 Takes = sum(PitchCall %in% c("StrikeCalled", "BallCalled", "HitByPitch", "BallinDirt")),
                 SwStr = sum(PitchCall == "StrikeSwinging"),
                 WhiffPerc = 100*round(SwStr/Swings, 3),
                 HR = sum(PlayResult == "HomeRun"),
                 BABIP = (sum(PlayResult %in% c("Single", "Double", "Triple"))/
                   sum(PlayResult %in% c("Single", "Double", "Triple", "Out", "Error", "FieldersChoice") | 
                         (TaggedHitType == "Bunt" & PlayResult == "Sacrifice"))) %>% round(3),
                 .groups = "keep") %>%
       rename(Name = Pitcher, 'Pitch Type' = TaggedPitchType, 'Whiff %' = WhiffPerc),
       options = list(scrollX = T))
  })
  
  ################################################################################################################
  ### Tab 2- Profiles
  # Player profile pics
  observe({
    output[[paste0("pic_", 
                   paste0(unlist(str_extract_all(input$Dash, "[:upper:]")), collapse = ""))]] <- renderImage({
                     find_pic(input$Dash)
                     }, deleteFile = TRUE)
  })
  
  observe({
    output[[paste0("stats_", 
                   paste0(unlist(str_extract_all(input$Dash, "[:upper:]")), collapse = ""))]] <- renderDataTable({
                     datatable(find_stats(input$Dash), rownames = FALSE)
                     })
  })
  
}

shinyApp(ui, server, options = list(height = 920, width = 980))
# Tab ideas:
# Game summaries(Add filters for batter handedness, results of the pitch), player profiles(stats for season along with pitch tunneling), pitcher comps, season long stats(velo and spin throughout year along with stats), thresholds(pitches above speed or above a certain location)
```

