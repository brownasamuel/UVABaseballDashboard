---
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load packages
library(tidyverse)
library(shiny)
library(DT)
library(knitr)
library(ggpubr)
library(kableExtra)

# Read in data
allGames <- read.csv("2023 Season Data.csv")

virginia <-  allGames %>%
  filter(PitcherTeam == 'Virginia') %>%
  mutate(opponent = paste(BatterTeam, sub("/2023", "", Date))) %>%
  select(-c(50:167))
pitcher <- unique(virginia$Pitcher)
```

```{r, echo = FALSE}
ui <- fluidPage(
  titlePanel("UVA Baseball Pitching Dashboard"),
  tags$head(
    tags$style(
      HTML(
        "
        
        /* Change the background color of the navbar */
        .navbar {
          background-color: #E57200;
        }
        
        /* Change the color of the text in the navbar */
        .navbar-default .navbar-nav > li > a {
          color: white;
        }
        
        /* Change the color of the active tab */
        .navbar-default .navbar-nav > .active > a,
        .navbar-default .navbar-nav > .active > a:focus,
        .navbar-default .navbar-nav > .active > a:hover {
          background-color: #232D4B;
          color: white;
        }
        "
      )
    )
  ),
  navbarPage(
    title = " ",
    # Page 1
    tabPanel(title = "Game Summaries",
             sidebarLayout(
               sidebarPanel(width = 4,
                            selectizeInput("pitcher", "Select a Pitcher", 
                                        choices = pitcher, 
                                        options = list(maxOptions = 5, 
                                                       placeholder = 'Please select an option below',
                                                       onInitialize = I('function() { this.setValue(""); }'))),
                         
                         uiOutput("Opponent"),
                         
                         uiOutput("PType1")),
               
               mainPanel(width = 8,
                         
                         conditionalPanel("input.PitchType1 != ''",
                                div(plotOutput("pitchZone")))
                         
                         )),
             
             fluidRow(
               column(12,
                      conditionalPanel("input.PitchType1 != ''",
                                       div(DT::dataTableOutput("mytable"), style = "font-size: 70%; width: 100%"))
                      )
               ),
             
             
             )
    )
  )

server = function(input, output) {
  
  output$Opponent <- renderUI({
    conditionalPanel("input.pitcher != '' ",
                     selectizeInput("opponent", "Opponent", 
                                    choices = virginia %>% 
                                      filter(Pitcher == input$pitcher) %>% 
                                      pull(opponent) %>% 
                                      unique(),
                                    options = list(maxOptions = 5, 
                                                   placeholder = 'Please select an option below',
                                                   onInitialize = I('function() { this.setValue(""); }'))))
  })
  
  output$PType1 <- renderUI({
    conditionalPanel("input.opponent != '' ",
                     selectizeInput("PitchType1", "Pitch Type", 
                                    choices = virginia %>% 
                                      filter(Pitcher == input$pitcher,
                                             opponent == input$opponent) %>% 
                                      pull(TaggedPitchType) %>% 
                                      unique(), 
                                    options = list(maxOptions = 5, 
                                                   placeholder = 'Please select an option below',
                                                   onInitialize = I('function() { this.setValue(""); }'))))
  })
  
  output$pitchZone <- renderPlot(
    virginia %>%
      filter(PitchCall != "",
             Pitcher == input$pitcher,
             opponent == input$opponent,
             TaggedPitchType == input$PitchType1) %>%
      ggplot(aes(x = PlateLocSide, y = PlateLocHeight)) +
      geom_point(aes(color = RelSpeed), na.rm = TRUE) +
      xlim(-2.5, 2.5) +
      theme_bw() +
      labs(y = "Pitch Height(ft)", x = "Pitch Horizontal Location(ft)", color = "Velocity") +
      geom_path(data = data.frame(x = c(-.8, -.8, .8, .8, -.8),
                                  y = c(1.6, 3.5, 3.5, 1.6, 1.6)), 
                aes(x = x, y = y)) +
      scale_color_gradient(low = "#181C90", high = "#F78707") +
      facet_grid(. ~ TaggedPitchType) +
      coord_equal()
  )
  
  output$mytable <- DT::renderDataTable({
    datatable(virginia %>%
       filter(PitchCall != "",
              TaggedPitchType == input$PitchType1,
              Pitcher == input$pitcher,
              opponent == input$opponent) %>%
       group_by(Pitcher, TaggedPitchType) %>%
       summarize(Velo = paste(round(quantile(RelSpeed, .25), 1), 
                              "-",
                             round(quantile(RelSpeed, .75), 1)),
                 'Total Pitches' = n(),
                 Strikes = sum(PitchCall %in% c("StrikeCalled", "StrikeSwinging", "FoulBall", "InPlay")),
                 Balls = sum(PitchCall %in% c("BallCalled", "HitByPitch", "BallinDirt", "BallIntentional")),
                 Swings = sum(PitchCall %in% c("FoulBall", "InPlay", "StrikeSwinging")),
                 Takes = sum(PitchCall %in% c("StrikeCalled", "BallCalled", "HitByPitch", "BallinDirt")),
                 SwStr = sum(PitchCall == "StrikeSwinging"),
                 WhiffPerc = 100*round(SwStr/Swings, 3),
                 HR = sum(PlayResult == "HomeRun"),
                 BABIP = (sum(PlayResult %in% c("Single", "Double", "Triple"))/
                   sum(PlayResult %in% c("Single", "Double", "Triple", "Out", "Error", "FieldersChoice") | 
                         (TaggedHitType == "Bunt" & PlayResult == "Sacrifice"))) %>% round(3),
                 .groups = "keep") %>%
       rename(Name = Pitcher, 'Pitch Type' = TaggedPitchType, 'Whiff %' = WhiffPerc),
       options = list(scrollX = T))
    })
  
  
}

shinyApp(ui, server, options = list(height = 920, width = 980))
```

